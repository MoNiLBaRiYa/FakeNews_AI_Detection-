<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="View real-time global fake news threat map and detection statistics">
    <title>TruthGuard AI - Global Threat Map</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <!-- Leaflet for real world map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- City coordinates database -->
    <script src="{{ url_for('static', filename='js/city-coords.js') }}"></script>
    <style>
        @keyframes gradientFlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .grid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(99, 102, 241, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(99, 102, 241, 0.05) 1px, transparent 1px);
            background-size: 42px 42px;
            z-index: 1;
            opacity: 0.7;
            mask-image: radial-gradient(circle at center, black, transparent 70%);
        }

        /* Container */
        .container {
            position: relative;
            z-index: 10;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 32px;
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.92));
            backdrop-filter: blur(22px);
            border-radius: 22px;
            border: 1px solid var(--border-soft);
            margin-bottom: 28px;
            box-shadow:
                0 22px 60px rgba(15, 23, 42, 0.85),
                0 0 0 1px rgba(15, 23, 42, 0.95);
            animation: slideDown 0.6s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: radial-gradient(circle at 30% 30%, var(--primary), var(--secondary));
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow:
                0 0 0 1px rgba(15, 23, 42, 0.95),
                0 16px 40px rgba(79, 70, 229, 0.65);
        }

        .logo-text h1 {
            font-size: 26px;
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            background: linear-gradient(125deg, #e5e7eb, #a5b4fc, #7dd3fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-text p {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 11px 22px;
            border-radius: 999px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.24s ease;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: radial-gradient(circle at 10% 0, #4f46e5, #6366f1);
            color: #f9fafb;
            box-shadow:
                0 14px 35px rgba(79, 70, 229, 0.7),
                0 0 0 1px rgba(15, 23, 42, 0.9);
        }

        .btn-primary:hover {
            transform: translateY(-1px) scale(1.01);
            box-shadow:
                0 18px 45px rgba(79, 70, 229, 0.85),
                0 0 0 1px rgba(15, 23, 42, 0.95);
        }

        .btn-secondary {
            background: rgba(15, 23, 42, 0.85);
            color: var(--text-main);
            border: 1px solid rgba(148, 163, 184, 0.35);
        }

        .btn-secondary:hover {
            background: rgba(30, 64, 175, 0.35);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(15, 23, 42, 0.85);
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.35);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        /* Stats Dashboard */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 26px;
            animation: fadeIn 0.8s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .stat-card {
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(22px);
            border-radius: 18px;
            border: 1px solid var(--border-soft);
            padding: 22px;
            transition: all 0.26s ease;
            box-shadow:
                0 18px 45px rgba(15, 23, 42, 0.9),
                0 0 0 1px rgba(15, 23, 42, 0.95);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: rgba(99, 102, 241, 0.9);
            box-shadow:
                0 22px 55px rgba(15, 23, 42, 0.95),
                0 0 0 1px rgba(15, 23, 42, 0.98);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-icon {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-icon.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .stat-icon.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .stat-icon.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .stat-icon.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .stat-trend {
            font-size: 12px;
            color: var(--success);
            margin-top: 8px;
        }

        /* Map Container */
        .map-container {
            background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.94));
            backdrop-filter: blur(22px);
            border-radius: 22px;
            border: 1px solid var(--border-soft);
            padding: 32px 30px 32px 30px;
            margin-bottom: 28px;
            box-shadow:
                0 24px 70px rgba(15, 23, 42, 0.95),
                0 0 0 1px rgba(15, 23, 42, 0.98);
            animation: slideUp 0.8s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .map-header {
            margin-bottom: 30px;
        }

        .map-header h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .map-header p {
            color: var(--text-muted);
            font-size: 13px;
        }

        .map-mode-toggle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
            padding: 4px;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.35);
        }

        .mode-btn {
            padding: 6px 12px;
            border-radius: 999px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-btn.active {
            background: radial-gradient(circle at 10% 0, #4f46e5, #6366f1);
            color: #f9fafb;
            box-shadow:
                0 8px 20px rgba(79, 70, 229, 0.6),
                0 0 0 1px rgba(15, 23, 42, 0.95);
        }

        .mode-btn:not(.active):hover {
            background: rgba(30, 64, 175, 0.4);
            color: #e5e7eb;
        }

        .world-map {
            position: relative;
            width: 100%;
            height: 500px;
            background: radial-gradient(circle at center, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.98));
            border-radius: 18px;
            overflow: hidden;
            box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.9);
        }

        .map-container-inner {
            position: relative;
            width: 100%;
            height: 100%;
            display: block;
        }

        #leafletMap {
            width: 100%;
            height: 100%;
        }

        .map-svg path {
            fill: rgba(99, 102, 241, 0.15);
            stroke: rgba(99, 102, 241, 0.4);
            stroke-width: 0.5;
            transition: all 0.3s ease;
        }

        .map-svg path:hover {
            fill: rgba(99, 102, 241, 0.3);
            stroke: rgba(99, 102, 241, 0.7);
        }

        /* Threat Markers */
        .threat-marker {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            animation: pulse 2s infinite;
            cursor: pointer;
            transform: translate(-50%, -50%);
            z-index: 10;
            transition: all 0.3s ease;
        }

        .threat-marker::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            opacity: 0.3;
            animation: ripple 2s infinite;
        }

        .threat-marker:hover {
            transform: translate(-50%, -50%) scale(1.3);
            z-index: 20;
        }

        .threat-marker.high {
            background: radial-gradient(circle, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.7));
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.8), 0 0 40px rgba(239, 68, 68, 0.4);
        }

        .threat-marker.high::before {
            background: radial-gradient(circle, rgba(239, 68, 68, 0.6), transparent);
        }

        .threat-marker.medium {
            background: radial-gradient(circle, rgba(245, 158, 11, 0.9), rgba(217, 119, 6, 0.7));
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.8), 0 0 40px rgba(245, 158, 11, 0.4);
        }

        .threat-marker.medium::before {
            background: radial-gradient(circle, rgba(245, 158, 11, 0.6), transparent);
        }

        .threat-marker.low {
            background: radial-gradient(circle, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 0.7));
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.8), 0 0 40px rgba(59, 130, 246, 0.4);
        }

        .threat-marker.low::before {
            background: radial-gradient(circle, rgba(59, 130, 246, 0.6), transparent);
        }

        @keyframes pulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 0.8;
            }
        }

        @keyframes ripple {
            0% {
                transform: scale(1);
                opacity: 0.6;
            }
            100% {
                transform: scale(2.5);
                opacity: 0;
            }
        }

        /* Recent Threats */
        .threats-section {
            background: radial-gradient(circle at bottom, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.94));
            backdrop-filter: blur(22px);
            border-radius: 22px;
            border: 1px solid var(--border-soft);
            padding: 32px;
            box-shadow:
                0 24px 70px rgba(15, 23, 42, 0.95),
                0 0 0 1px rgba(15, 23, 42, 0.98);
        }

        .threats-header {
            margin-bottom: 25px;
        }

        .threats-header h2 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .threats-subtitle {
            color: var(--text-muted);
            font-size: 13px;
        }

        .threats-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .threat-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border-left: 3px solid;
            transition: all 0.3s ease;
        }

        .threat-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .threat-item.high {
            border-color: var(--danger);
        }

        .threat-item.medium {
            border-color: var(--warning);
        }

        .threat-item.low {
            border-color: var(--success);
        }

        .threat-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .threat-badge.high {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .threat-badge.medium {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }

        .threat-badge.low {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        .threat-info {
            flex: 1;
        }

        .threat-location {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .threat-time {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }

        .threat-count {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        @media (max-width: 768px) {
            .stats-dashboard {
                grid-template-columns: 1fr;
            }
            
            .world-map {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-container"></div>
    <div class="grid-bg"></div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo-section">
                <div class="logo-icon">üåç</div>
                <div class="logo-text">
                    <h1>Global Threat Map</h1>
                    <p>Real-time Fake News Detection</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="window.location.href='/analyzer'" aria-label="Navigate to analyzer">
                    <i class="fas fa-search" aria-hidden="true"></i> Analyzer
                </button>
                <div class="user-info">
                    <div class="user-avatar">üë§</div>
                    <span style="font-size: 13px; color: var(--text-main);">User</span>
                </div>
                <button class="btn btn-secondary" onclick="handleLogout()" aria-label="Logout from account">
                    <i class="fas fa-sign-out-alt" aria-hidden="true"></i> Logout
                </button>
            </div>
        </header>

        <!-- Stats Dashboard -->
        <div class="stats-dashboard">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon danger">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="stat-value">1,247</div>
                <div class="stat-label">Fake News Detected</div>
                <div class="stat-trend">‚Üë 12% from last week</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
                <div class="stat-value">8,932</div>
                <div class="stat-label">Verified Articles</div>
                <div class="stat-trend">‚Üë 8% from last week</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon warning">
                        <i class="fas fa-globe"></i>
                    </div>
                </div>
                <div class="stat-value">45</div>
                <div class="stat-label">Active Regions</div>
                <div class="stat-trend">‚Üí Stable</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon info">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <div class="stat-value">99.6%</div>
                <div class="stat-label">Detection Accuracy</div>
                <div class="stat-trend">‚Üë 0.2% improvement</div>
            </div>
        </div>

        <!-- World Map -->
        <div class="map-container">
            <div class="map-header" style="display:flex;justify-content:space-between;align-items:flex-end;gap:16px;flex-wrap:wrap;">
                <div>
                    <h2>Global Threat Distribution</h2>
                    <p>Real-time visualization of fake news detection across regions</p>
                    <div class="map-mode-toggle" role="tablist" aria-label="Threat map mode">
                        <button class="mode-btn active" data-mode="local" role="tab" aria-selected="true">
                            My Region
                        </button>
                        <button class="mode-btn" data-mode="india" role="tab" aria-selected="false">
                            India
                        </button>
                        <button class="mode-btn" data-mode="world" role="tab" aria-selected="false">
                            World
                        </button>
                    </div>
                </div>
                <button class="btn btn-secondary" id="useLocationBtn" type="button" aria-label="Use live location">
                    <i class="fas fa-location-arrow" aria-hidden="true"></i>
                    Use My Live Location
                </button>
            </div>
            <div class="world-map" id="worldMap">
                <div class="map-container-inner">
                    <div id="leafletMap"></div>
                </div>
            </div>
        </div>

        <!-- Recent Threats -->
        <div class="threats-section">
            <div class="threats-header">
                <h2>Regional Threat Activity</h2>
                <p class="threats-subtitle">
                    Showing fake news activity for
                    <span id="userRegionLabel">detecting your location‚Ä¶</span>
                </p>
            </div>
            <div class="threats-list" id="regionalThreatsList"></div>
        </div>
    </div>

    <script>
        const mapElement = document.getElementById('worldMap');
        const useLocationBtn = document.getElementById('useLocationBtn');
        const modeButtons = document.querySelectorAll('.mode-btn');
        const regionalThreatsList = document.getElementById('regionalThreatsList');
        const userRegionLabel = document.getElementById('userRegionLabel');
        let leafletMap = null;
        let threatLayer = null;
        let currentMode = 'local';
        let lastPosition = null;

        // CITY_COORDS is now loaded from city-coords.js
        // Fallback if not loaded
        if (typeof CITY_COORDS === 'undefined') {
            console.warn('City coordinates database not loaded, using fallback');
            var CITY_COORDS = {
            // Gujarat & nearby (local focus)
            ahmedabad: { lat: 23.0225, lon: 72.5714, label: 'Ahmedabad' },
            amdavad:   { lat: 23.0225, lon: 72.5714, label: 'Ahmedabad' },
            '‡™Ö‡™Æ‡™¶‡™æ‡™µ‡™æ‡™¶': { lat: 23.0225, lon: 72.5714, label: 'Ahmedabad' },  // Ahmedabad in Gujarati
            vadodara:  { lat: 22.3072, lon: 73.1812, label: 'Vadodara' },
            baroda:    { lat: 22.3072, lon: 73.1812, label: 'Vadodara' },
            '‡™µ‡™°‡´ã‡™¶‡™∞‡™æ':  { lat: 22.3072, lon: 73.1812, label: 'Vadodara' },  // Vadodara in Gujarati
            surat:     { lat: 21.1702, lon: 72.8311, label: 'Surat' },
            '‡™∏‡´Å‡™∞‡™§':    { lat: 21.1702, lon: 72.8311, label: 'Surat' },  // Surat in Gujarati
            rajkot:    { lat: 22.3039, lon: 70.8022, label: 'Rajkot' },
            '‡™∞‡™æ‡™ú‡™ï‡´ã‡™ü':  { lat: 22.3039, lon: 70.8022, label: 'Rajkot' },  // Rajkot in Gujarati
            dwarka:    { lat: 22.2394, lon: 68.9678, label: 'Dwarka' },
            '‡™¶‡´ç‡™µ‡™æ‡™∞‡™ï‡™æ':  { lat: 22.2394, lon: 68.9678, label: 'Dwarka' },  // Dwarka in Gujarati
            somnath:   { lat: 20.8880, lon: 70.4012, label: 'Somnath' },
            '‡™∏‡´ã‡™Æ‡™®‡™æ‡™•':  { lat: 20.8880, lon: 70.4012, label: 'Somnath' },  // Somnath in Gujarati
            junagadh:  { lat: 21.5222, lon: 70.4579, label: 'Junagadh' },
            '‡™ú‡´Ç‡™®‡™æ‡™ó‡™¢':  { lat: 21.5222, lon: 70.4579, label: 'Junagadh' },  // Junagadh in Gujarati
            bhavnagar: { lat: 21.7645, lon: 72.1519, label: 'Bhavnagar' },
            '‡™≠‡™æ‡™µ‡™®‡™ó‡™∞': { lat: 21.7645, lon: 72.1519, label: 'Bhavnagar' },  // Bhavnagar in Gujarati
            jamnagar:  { lat: 22.4707, lon: 70.0577, label: 'Jamnagar' },
            '‡™ú‡™æ‡™Æ‡™®‡™ó‡™∞': { lat: 22.4707, lon: 70.0577, label: 'Jamnagar' },  // Jamnagar in Gujarati
            veraval:   { lat: 20.9075, lon: 70.3679, label: 'Veraval' },
            '‡™µ‡´á‡™∞‡™æ‡™µ‡™≥':  { lat: 20.9075, lon: 70.3679, label: 'Veraval' },  // Veraval in Gujarati
            'veraval bypass': { lat: 20.9075, lon: 70.3679, label: 'Veraval' },
            'murlidhar complex': { lat: 20.9075, lon: 70.3679, label: 'Veraval' },
            tala:      { lat: 20.9583, lon: 70.5080, label: 'Talala' },
            talala:    { lat: 20.9583, lon: 70.5080, label: 'Talala' },
            '‡™§‡™æ‡™≤‡™æ‡™≤‡™æ':  { lat: 20.9583, lon: 70.5080, label: 'Talala' },  // Talala in Gujarati
            kodinar:   { lat: 20.7926, lon: 70.7020, label: 'Kodinar' },
            '‡™ï‡´ã‡™°‡´Ä‡™®‡™æ‡™∞': { lat: 20.7926, lon: 70.7020, label: 'Kodinar' },  // Kodinar in Gujarati
            somnath:   { lat: 20.8880, lon: 70.4012, label: 'Somnath' },
            '‡™∏‡´ã‡™Æ‡™®‡™æ‡™•':  { lat: 20.8880, lon: 70.4012, label: 'Somnath' },  // Somnath in Gujarati
            junagadh:  { lat: 21.5222, lon: 70.4579, label: 'Junagadh' },
            '‡™ú‡´Ç‡™®‡™æ‡™ó‡™¢':  { lat: 21.5222, lon: 70.4579, label: 'Junagadh' },  // Junagadh in Gujarati
            'new delhi':  { lat: 28.6139, lon: 77.2090, label: 'New Delhi' },
            delhi:        { lat: 28.6139, lon: 77.2090, label: 'Delhi' },
            '‡§¶‡§ø‡§≤‡•ç‡§≤‡•Ä':     { lat: 28.6139, lon: 77.2090, label: 'Delhi' },  // Delhi in Hindi
            mumbai:       { lat: 19.0760, lon: 72.8777, label: 'Mumbai' },
            bombay:       { lat: 19.0760, lon: 72.8777, label: 'Mumbai' },
            '‡§Æ‡•Å‡§Ç‡§¨‡§à':      { lat: 19.0760, lon: 72.8777, label: 'Mumbai' },  // Mumbai in Hindi
            'navi mumbai':{ lat: 19.0330, lon: 73.0297, label: 'Navi Mumbai' },
            pune:         { lat: 18.5204, lon: 73.8567, label: 'Pune' },
            '‡§™‡•Å‡§£‡•á':       { lat: 18.5204, lon: 73.8567, label: 'Pune' },  // Pune in Hindi
            nagpur:       { lat: 21.1458, lon: 79.0882, label: 'Nagpur' },
            '‡§®‡§æ‡§ó‡§™‡•Å‡§∞':     { lat: 21.1458, lon: 79.0882, label: 'Nagpur' },  // Nagpur in Hindi
            'kolkata':    { lat: 22.5726, lon: 88.3639, label: 'Kolkata' },
            calcutta:     { lat: 22.5726, lon: 88.3639, label: 'Kolkata' },
            '‡§ï‡•ã‡§≤‡§ï‡§æ‡§§‡§æ':    { lat: 22.5726, lon: 88.3639, label: 'Kolkata' },  // Kolkata in Hindi
            chennai:      { lat: 13.0827, lon: 80.2707, label: 'Chennai' },
            '‡Æö‡ØÜ‡Æ©‡Øç‡Æ©‡Øà':    { lat: 13.0827, lon: 80.2707, label: 'Chennai' },  // Chennai in Tamil
            '‡§ö‡•á‡§®‡•ç‡§®‡§à':     { lat: 13.0827, lon: 80.2707, label: 'Chennai' },  // Chennai in Hindi
            bengaluru:    { lat: 12.9716, lon: 77.5946, label: 'Bengaluru' },
            bangalore:    { lat: 12.9716, lon: 77.5946, label: 'Bengaluru' },
            '‡§¨‡•á‡§Ç‡§ó‡§≤‡•Å‡§∞‡•Å':   { lat: 12.9716, lon: 77.5946, label: 'Bengaluru' },  // Bengaluru in Hindi
            '‡≤¨‡≥Ü‡≤Ç‡≤ó‡≤≥‡≥Ç‡≤∞‡≥Å':  { lat: 12.9716, lon: 77.5946, label: 'Bengaluru' },  // Bengaluru in Kannada
            hyderabad:    { lat: 17.3850, lon: 78.4867, label: 'Hyderabad' },
            '‡§π‡•à‡§¶‡§∞‡§æ‡§¨‡§æ‡§¶':   { lat: 17.3850, lon: 78.4867, label: 'Hyderabad' },  // Hyderabad in Hindi
            '‡∞π‡±à‡∞¶‡∞∞‡∞æ‡∞¨‡∞æ‡∞¶‡±ç': { lat: 17.3850, lon: 78.4867, label: 'Hyderabad' },  // Hyderabad in Telugu
            jaipur:       { lat: 26.9124, lon: 75.7873, label: 'Jaipur' },
            '‡§ú‡§Ø‡§™‡•Å‡§∞':      { lat: 26.9124, lon: 75.7873, label: 'Jaipur' },  // Jaipur in Hindi
            lucknow:      { lat: 26.8467, lon: 80.9462, label: 'Lucknow' },
            '‡§≤‡§ñ‡§®‡§ä':       { lat: 26.8467, lon: 80.9462, label: 'Lucknow' },  // Lucknow in Hindi
            kanpur:       { lat: 26.4499, lon: 80.3319, label: 'Kanpur' },
            '‡§ï‡§æ‡§®‡§™‡•Å‡§∞':     { lat: 26.4499, lon: 80.3319, label: 'Kanpur' },  // Kanpur in Hindi
            patna:        { lat: 25.5941, lon: 85.1376, label: 'Patna' },
            '‡§™‡§ü‡§®‡§æ':       { lat: 25.5941, lon: 85.1376, label: 'Patna' },  // Patna in Hindi
            ranchi:       { lat: 23.3441, lon: 85.3096, label: 'Ranchi' },
            '‡§∞‡§æ‡§Ç‡§ö‡•Ä':      { lat: 23.3441, lon: 85.3096, label: 'Ranchi' },  // Ranchi in Hindi
            bhopal:       { lat: 23.2599, lon: 77.4126, label: 'Bhopal' },
            '‡§≠‡•ã‡§™‡§æ‡§≤':      { lat: 23.2599, lon: 77.4126, label: 'Bhopal' },  // Bhopal in Hindi
            indore:       { lat: 22.7196, lon: 75.8577, label: 'Indore' },
            '‡§á‡§Ç‡§¶‡•å‡§∞':      { lat: 22.7196, lon: 75.8577, label: 'Indore' },  // Indore in Hindi
            ahmednagar:   { lat: 19.0946, lon: 74.7480, label: 'Ahmednagar' },
            'aurangabad': { lat: 19.8762, lon: 75.3433, label: 'Aurangabad' },
            'bhubaneswar':{ lat: 20.2961, lon: 85.8245, label: 'Bhubaneswar' },
            cuttack:      { lat: 20.4625, lon: 85.8828, label: 'Cuttack' },
            kochi:        { lat: 9.9312,  lon: 76.2673, label: 'Kochi' },
            ernakulam:    { lat: 9.9816,  lon: 76.2999, label: 'Ernakulam' },
            'thiruvananthapuram': { lat: 8.5241, lon: 76.9366, label: 'Thiruvananthapuram' },
            trivandrum:   { lat: 8.5241,  lon: 76.9366, label: 'Thiruvananthapuram' },
            chandigarh:   { lat: 30.7333, lon: 76.7794, label: 'Chandigarh' },
            srinagar:     { lat: 34.0837, lon: 74.7973, label: 'Srinagar' },
            jammu:        { lat: 32.7266, lon: 74.8570, label: 'Jammu' },
            dehradun:     { lat: 30.3165, lon: 78.0322, label: 'Dehradun' },
            shimla:       { lat: 31.1048, lon: 77.1734, label: 'Shimla' },
            guwahati:     { lat: 26.1445, lon: 91.7362, label: 'Guwahati' },
            imphal:       { lat: 24.8170, lon: 93.9368, label: 'Imphal' },
            shillong:     { lat: 25.5788, lon: 91.8933, label: 'Shillong' },
            agartala:     { lat: 23.8315, lon: 91.2868, label: 'Agartala' },
            kohima:       { lat: 25.6751, lon: 94.1086, label: 'Kohima' },
            aizawl:       { lat: 23.7271, lon: 92.7176, label: 'Aizawl' },
            itanagar:     { lat: 27.0844, lon: 93.6053, label: 'Itanagar' },
            gangtok:      { lat: 27.3314, lon: 88.6138, label: 'Gangtok' },
            panaji:       { lat: 15.4909, lon: 73.8278, label: 'Panaji' },
            goa:          { lat: 15.2993, lon: 74.1240, label: 'Goa' },
            'puducherry': { lat: 11.9416, lon: 79.8083, label: 'Puducherry' },
            'port blair': { lat: 11.6234, lon: 92.7265, label: 'Port Blair' },
            daman:        { lat: 20.3974, lon: 72.8328, label: 'Daman' },
            diu:          { lat: 20.7141, lon: 70.9870, label: 'Diu' },
            silvassa:     { lat: 20.2739, lon: 73.0083, label: 'Silvassa' },
            dnh:          { lat: 20.2739, lon: 73.0083, label: 'Dadra and Nagar Haveli' },
            dadra:        { lat: 20.3250, lon: 72.9660, label: 'Dadra and Nagar Haveli' },
            'dadra and nagar haveli': { lat: 20.3250, lon: 72.9660, label: 'Dadra and Nagar Haveli' },
            kavaratti:    { lat: 10.5667, lon: 72.6420, label: 'Kavaratti' }
            };
        }

        function ensureLeafletMap() {
            if (leafletMap) return;

            leafletMap = L.map('leafletMap', {
                worldCopyJump: true,
                zoomControl: true
            }).setView([20, 0], 2);

            // Light OpenStreetMap tiles (clean, familiar look)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(leafletMap);

            threatLayer = L.layerGroup().addTo(leafletMap);
        }

        /**
         * Enhanced region + city detection from coordinates.
         * Uses proximity matching to find nearest city from database.
         */
        function inferRegionFromCoords(lat, lon) {
            let nearestCity = null;
            let minDistance = Infinity;
            
            // Find nearest city using Haversine distance
            for (const [key, coords] of Object.entries(CITY_COORDS)) {
                const distance = Math.sqrt(
                    Math.pow(lat - coords.lat, 2) + Math.pow(lon - coords.lon, 2)
                );
                
                // If within ~50km (roughly 0.5 degrees), consider it a match
                if (distance < 0.5 && distance < minDistance) {
                    minDistance = distance;
                    nearestCity = coords;
                }
            }
            
            // If we found a nearby city, use it
            if (nearestCity) {
                const state = nearestCity.state || '';
                const region = determineRegionFromState(state);
                return {
                    region,
                    label: `${nearestCity.label}, ${state}`,
                    state,
                    city: nearestCity.label
                };
            }
            
            // Fallback: Use bounding boxes for states/regions
            // Gujarat
            if (lat >= 20 && lat <= 24.5 && lon >= 68 && lon <= 74) {
                return { region: 'gujarat', label: 'Gujarat, India', state: 'Gujarat', city: '' };
            }
            
            // Maharashtra
            if (lat >= 15.5 && lat <= 22 && lon >= 72.5 && lon <= 80.5) {
                return { region: 'india', label: 'Maharashtra, India', state: 'Maharashtra', city: '' };
            }
            
            // Karnataka
            if (lat >= 11.5 && lat <= 18.5 && lon >= 74 && lon <= 78.5) {
                return { region: 'india', label: 'Karnataka, India', state: 'Karnataka', city: '' };
            }
            
            // Tamil Nadu
            if (lat >= 8 && lat <= 13.5 && lon >= 76.5 && lon <= 80.5) {
                return { region: 'india', label: 'Tamil Nadu, India', state: 'Tamil Nadu', city: '' };
            }
            
            // Kerala
            if (lat >= 8 && lat <= 12.5 && lon >= 74.5 && lon <= 77.5) {
                return { region: 'india', label: 'Kerala, India', state: 'Kerala', city: '' };
            }
            
            // Delhi NCR
            if (lat >= 28 && lat <= 29 && lon >= 76.5 && lon <= 77.5) {
                return { region: 'india', label: 'Delhi NCR, India', state: 'Delhi', city: '' };
            }
            
            // West Bengal
            if (lat >= 21.5 && lat <= 27 && lon >= 85.5 && lon <= 89.5) {
                return { region: 'india', label: 'West Bengal, India', state: 'West Bengal', city: '' };
            }
            
            // Rajasthan
            if (lat >= 23 && lat <= 30 && lon >= 69.5 && lon <= 78) {
                return { region: 'india', label: 'Rajasthan, India', state: 'Rajasthan', city: '' };
            }
            
            // Uttar Pradesh
            if (lat >= 23.5 && lat <= 30.5 && lon >= 77 && lon <= 84.5) {
                return { region: 'india', label: 'Uttar Pradesh, India', state: 'Uttar Pradesh', city: '' };
            }
            
            // General India
            if (lat >= 6 && lat <= 37 && lon >= 68 && lon <= 97) {
                return { region: 'india', label: 'India', state: '', city: '' };
            }
            
            // International
            return { region: 'international', label: 'Worldwide', state: '', city: '' };
        }
        
        /**
         * Determine region (gujarat/india/international) from state name
         */
        function determineRegionFromState(state) {
            if (!state) return 'india';
            const stateLower = state.toLowerCase();
            if (stateLower === 'gujarat') return 'gujarat';
            if (stateLower.includes('india') || stateLower.includes('delhi') || 
                stateLower.includes('maharashtra') || stateLower.includes('karnataka') ||
                stateLower.includes('tamil') || stateLower.includes('kerala') ||
                stateLower.includes('bengal') || stateLower.includes('rajasthan') ||
                stateLower.includes('pradesh') || stateLower.includes('bihar') ||
                stateLower.includes('punjab') || stateLower.includes('haryana')) {
                return 'india';
            }
            return 'india'; // Default to India for all Indian states
        }

        function getLanguageForRegion(regionInfo) {
            // Default English; Gujarati for Gujarat specifically
            if (regionInfo.region === 'gujarat') {
                return 'gu';
            }
            return 'en';
        }

        function getCityCoordsFromArticle(article) {
            const lower = article.toLowerCase();
            
            // First, extract the city label if present (e.g., [Veraval], [Talala])
            const labelMatch = article.match(/\[([^\]]+)\]/);
            if (labelMatch) {
                const labelCity = labelMatch[1].toLowerCase();
                if (CITY_COORDS[labelCity]) {
                    return CITY_COORDS[labelCity];
                }
            }
            
            // Then check for city names in the article text
            // Sort by specificity (longer names first to avoid false matches)
            const cityKeys = Object.keys(CITY_COORDS).sort((a, b) => b.length - a.length);
            
            for (const key of cityKeys) {
                if (lower.includes(key)) {
                    return CITY_COORDS[key];
                }
            }
            
            return null;
        }

        function renderRegionalThreats(newsData, regionInfo, lat, lon) {
            regionalThreatsList.innerHTML = '';

            const news = Array.isArray(newsData.news) ? newsData.news : [];
            const predictions = Array.isArray(newsData.predictions) ? newsData.predictions : [];

            if (!news.length) {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'threat-item low';
                emptyItem.innerHTML = `
                    <span class="threat-badge low">Info</span>
                    <div class="threat-info">
                        <div class="threat-location">No regional news found</div>
                        <div class="threat-time">Try again in a few minutes</div>
                    </div>
                    <div class="threat-count">0</div>
                `;
                regionalThreatsList.appendChild(emptyItem);
                return;
            }

            news.slice(0, 8).forEach((article, index) => {
                const prediction = (predictions[index] || 'Real News').toString();
                const isFake = prediction.toLowerCase().includes('fake');
                const isUnknown = prediction.toLowerCase().includes('unknown');
                const severity = isFake ? 'high' : (isUnknown ? 'medium' : 'low');

                // Create list item
                const item = document.createElement('div');
                item.className = `threat-item ${severity}`;
                item.innerHTML = `
                    <span class="threat-badge ${severity}">${isFake ? 'High' : (isUnknown ? 'Unknown' : 'Low')}</span>
                    <div class="threat-info">
                        <div class="threat-location">${article}</div>
                        <div class="threat-time">Updated just now ‚Ä¢ ${regionInfo.label}</div>
                    </div>
                    <div class="threat-count">${isFake ? '‚ö†Ô∏è' : (isUnknown ? '‚ùì' : '‚úîÔ∏è')}</div>
                `;
                regionalThreatsList.appendChild(item);

                // Decide where to place this news marker.
                // Try to find city coordinates from article text first
                let cityCoords = getCityCoordsFromArticle(article);
                
                console.log(`Article ${index + 1}:`, article.substring(0, 100));
                console.log(`  - Found coords from article:`, cityCoords);
                
                // If no city found in article, use fallback logic
                if (!cityCoords) {
                    // Check if article mentions other major cities or states
                    const articleLower = article.toLowerCase();
                    
                    const majorCities = ['delhi', 'mumbai', 'kolkata', 'chennai', 'bengaluru', 'bangalore', 
                                        'hyderabad', 'pune', 'jaipur', 'lucknow', 'kanpur', 'nagpur',
                                        'surat', 'ahmedabad', 'rajkot'];
                    
                    const otherStates = ['punjab', 'haryana', 'kashmir', 'meghalaya', 'assam', 'manipur',
                                        'nagaland', 'mizoram', 'tripura', 'arunachal', 'west bengal',
                                        'odisha', 'jharkhand', 'bihar', 'karnataka', 'kerala', 'tamil nadu',
                                        'andhra pradesh', 'telangana', 'madhya pradesh', 'chhattisgarh',
                                        'maharashtra', 'rajasthan', 'uttar pradesh', 'up'];
                    
                    const userCity = regionInfo.city ? regionInfo.city.toLowerCase() : '';
                    const userState = regionInfo.state ? regionInfo.state.toLowerCase() : '';
                    
                    // Remove user's state from exclusion
                    const filteredStates = otherStates.filter(state => 
                        !userState.includes(state) && !state.includes(userState)
                    );
                    
                    const mentionsOtherCity = majorCities.some(city => 
                        city !== userCity && articleLower.includes(city)
                    );
                    
                    const mentionsOtherState = filteredStates.some(state => 
                        articleLower.includes(state)
                    );
                    
                    console.log(`  - Mentions other city: ${mentionsOtherCity}`);
                    console.log(`  - Mentions other state: ${mentionsOtherState}`);
                    
                    // Only use user location if article doesn't mention other cities/states
                    if (!mentionsOtherCity && !mentionsOtherState && currentMode === 'local' && lat && lon) {
                        cityCoords = { lat: lat, lon: lon, label: regionInfo.label };
                        console.log(`  - Using user location:`, cityCoords);
                    } else if (!mentionsOtherCity && !mentionsOtherState && regionInfo.city && CITY_COORDS[userCity]) {
                        cityCoords = CITY_COORDS[userCity];
                        console.log(`  - Using user city coords:`, cityCoords);
                    }
                }
                
                // If we still don't have coordinates, skip marker
                if (!cityCoords) {
                    console.log(`  - ‚ùå Skipping marker (no coordinates)`);
                    return;
                }

                console.log(`  - ‚úÖ Adding marker at:`, cityCoords);

                const markerLat = cityCoords.lat;
                const markerLon = cityCoords.lon;

                const color = isFake ? '#ef4444' : (isUnknown ? '#f59e0b' : '#3b82f6');
                const shortLabel = article.length > 90 ? article.slice(0, 87) + '‚Ä¶' : article;
                const placeLabel = cityCoords.label || regionInfo.label;
                const popup = `${placeLabel}<br/><br/><strong>${prediction}</strong><br/>${article}`;

                L.circleMarker([markerLat, markerLon], {
                    radius: isFake ? 8 : (isUnknown ? 7 : 6),
                    color,
                    weight: 2,
                    fillColor: color,
                    fillOpacity: 0.8
                }).bindPopup(popup).addTo(threatLayer);
            });
        }

        async function fetchRegionalNews(lat, lon) {
            try {
                const regionInfo = inferRegionFromCoords(lat, lon);
                const languageCode = getLanguageForRegion(regionInfo);
                userRegionLabel.textContent = regionInfo.label + (languageCode === 'gu' ? ' ‚Ä¢ ‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä' : ' ‚Ä¢ English');

                lastPosition = { lat, lon };
                currentMode = 'local';

                ensureLeafletMap();
                threatLayer.clearLayers();
                leafletMap.setView([lat, lon], regionInfo.region === 'international' ? 3 : 6);

                const params = new URLSearchParams({
                    query: 'latest',
                    region: regionInfo.region,
                    state: regionInfo.state || '',
                    city: regionInfo.city || '',
                    lat: String(lat),
                    lon: String(lon),
                    language: languageCode,
                });

                const response = await fetch(`/fetch_news?${params.toString()}`);
                const data = await response.json();

                console.log('Fetched news data:', data);
                console.log('Number of news items:', data.news ? data.news.length : 0);

                // Add a central marker for the user location
                L.marker([lat, lon])
                    .bindPopup(`Your approximate location<br/>${regionInfo.label}<br/>Lat: ${lat.toFixed(3)}, Lon: ${lon.toFixed(3)}`)
                    .addTo(threatLayer)
                    .openPopup();

                renderRegionalThreats(data, regionInfo, lat, lon);
                
                // After rendering, check if any markers were added
                const markerCount = threatLayer.getLayers().length;
                console.log(`Total markers on map: ${markerCount}`);
                
                if (markerCount > 1) {
                    // Zoom to fit all markers
                    const bounds = threatLayer.getBounds();
                    if (bounds.isValid()) {
                        leafletMap.fitBounds(bounds, { padding: [50, 50], maxZoom: 10 });
                    }
                }
            } catch (error) {
                console.error('Error fetching regional news:', error);
                userRegionLabel.textContent = 'worldwide (fallback)';

                if (threatLayer) {
                    threatLayer.clearLayers();
                }
            }
        }

        function initLocationAwareThreatMap() {
            if (!navigator.geolocation) {
                userRegionLabel.textContent = 'worldwide (location not supported)';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    fetchRegionalNews(latitude, longitude);
                },
                () => {
                    userRegionLabel.textContent = 'worldwide (permission denied)';
                },
                {
                    enableHighAccuracy: false,
                    timeout: 8000,
                    maximumAge: 300000,
                }
            );
        }

        // Initialize when page loads
        window.addEventListener('load', initLocationAwareThreatMap);
        if (useLocationBtn) {
            useLocationBtn.addEventListener('click', initLocationAwareThreatMap);
        }

        async function fetchIndiaNews() {
            try {
                currentMode = 'india';
                userRegionLabel.textContent = 'India ‚Ä¢ English';

                ensureLeafletMap();
                threatLayer.clearLayers();
                const centerLat = 22.5;
                const centerLon = 79;
                leafletMap.setView([centerLat, centerLon], 4);

                const params = new URLSearchParams({
                    query: 'latest',
                    region: 'india',
                    state: '',
                    city: '',
                    lat: '',
                    lon: '',
                    language: 'en',
                });

                const response = await fetch(`/fetch_news?${params.toString()}`);
                const data = await response.json();

                renderRegionalThreats(data, { region: 'india', label: 'India', state: '', city: '' }, centerLat, centerLon);
            } catch (error) {
                console.error('Error fetching India-wide news:', error);
            }
        }

        async function fetchWorldNews() {
            try {
                currentMode = 'world';
                userRegionLabel.textContent = 'Worldwide ‚Ä¢ English';

                ensureLeafletMap();
                threatLayer.clearLayers();
                const centerLat = 20;
                const centerLon = 0;
                leafletMap.setView([centerLat, centerLon], 2);

                const params = new URLSearchParams({
                    query: 'latest',
                    region: 'international',
                    state: '',
                    city: '',
                    lat: '',
                    lon: '',
                    language: 'en',
                });

                const response = await fetch(`/fetch_news?${params.toString()}`);
                const data = await response.json();

                renderRegionalThreats(
                    data,
                    { region: 'international', label: 'Worldwide', state: '', city: '' },
                    centerLat,
                    centerLon
                );
            } catch (error) {
                console.error('Error fetching international news:', error);
            }
        }

        // Mode toggle handlers
        modeButtons.forEach((btn) => {
            btn.addEventListener('click', () => {
                const mode = btn.dataset.mode;
                modeButtons.forEach((b) => b.classList.remove('active'));
                btn.classList.add('active');

                if (mode === 'local') {
                    currentMode = 'local';
                    if (lastPosition) {
                        fetchRegionalNews(lastPosition.lat, lastPosition.lon);
                    } else {
                        initLocationAwareThreatMap();
                    }
                } else if (mode === 'india') {
                    fetchIndiaNews();
                } else if (mode === 'world') {
                    fetchWorldNews();
                }
            });
        });

        // Auto-refresh simulation
        setInterval(() => {
            const statValues = document.querySelectorAll('.stat-value');
            statValues.forEach(stat => {
                const currentValue = parseInt(stat.textContent.replace(/,/g, ''));
                if (!isNaN(currentValue)) {
                    const newValue = currentValue + Math.floor(Math.random() * 5);
                    stat.textContent = newValue.toLocaleString();
                }
            });
        }, 5000);

        // Logout handler
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                fetch('/logout', { method: 'POST' })
                    .then(() => window.location.href = '/')
                    .catch(() => window.location.href = '/');
            }
        }
    </script>
</body>
</html>
